\sekshun{Input and Output}
\label{Input_and_Output}
% got one right below: \index{input and output}
\index{input/output}

\section{See Library Documentation}

Chapel includes an extensive library for input and output that is
documented in the standard library documentation. See
\url{http://chapel.cray.com/docs/latest/modules/standard/IO.html}.

\section{Writing and Reading}
\label{IO_writing_reading}

\begin{chapelexample}{HelloWorld.chpl}
The \chpl{writeln} function allows for a simple implementation
of the {\em Hello-World} program:
\begin{chapel}
writeln("Hello, World!");
\end{chapel}
The expected output is
\begin{chapelprintoutput}{}
Hello, World!
\end{chapelprintoutput}
\end{chapelexample}

\begin{example}
The following code shows three ways to read values into a pair of
variables \chpl{x} and \chpl{y}:
\begin{chapel}
var x: int;
var y: real;

/* reading into variable expressions, returning
   true if the values were read, false on EOF */
var ok:bool = read(x, y);

/* reading via a single type argument */
x = read(int);
y = read(real);

/* reading via multiple type arguments */
(x, y) = read(int, real);
\end{chapel}
\end{example}


\subsection{The {\em write} and {\em writeln} Methods on Strings}
\label{stringwrite}
\index{write!on strings}
\index{write (string)@\chpl{write} (string)}
\index{writeln (string)@\chpl{writeln} (string)}
\index{input/output!write (string)@\chpl{write} (string)}
\index{input/output!writeln (string)@\chpl{writeln} (string)}

The \chpl{write} and \chpl{writeln} methods can also be called on
strings to write the output to a string instead of a channel.


%?? \subsection{The {\em read} and {\em readln} method on strings}


\subsection{The {\em readThis}, {\em writeThis}, and {\em readWriteThis} Methods}

\label{User_Defined_writeThis_Methods}
\index{input/output!writeThis@\chpl{writeThis}}

When programming the input and output method for a custom data type, it is often useful to define both the read and write routines at the same time. That is possible to do in a Chapel program by defining a \chpl{readWriteThis} method, which is a generic method expecting a single argument: either a Reader or a Writer.

In cases when the reading routine and the writing routine are more naturally separate, or in which only one should be defined, a Chapel program can define \chpl{readThis} (taking in a single argument of type Reader) and/or \chpl{writeThis} (taking in a single argument of type Writer). 

If a none of these routines are provided, a default version of \chpl{readThis} and \chpl{writeThis} will be generated by the compiler. If \chpl{readWriteThis} is defined, the compiler will generate \chpl{readThis} or \chpl{writeThis} - if they do not already exist - which call \chpl{readWriteThis}.

Objects of type \chpl{Reader} or \chpl{Writer} both support the following methods:
\begin{chapel}
  /* Return true if we are a Writer (vs a Reader) */
  proc writing: bool;
  /* Return true if we are doing binary I/O */
  proc binary: bool;
  /* Return the current error */
  proc error():syserr;
  /* Set the current error */
  proc setError(e:syserr);
  /* Clear the current error */
  proc clearError();
  /* Read or write a value according to its readThis or writeThis method */
  proc readwrite(ref x);
\end{chapel}

Objects of type \chpl{Reader} also supports the following methods:
\begin{chapel}
  /* as with channel.read */
  proc read(ref args ...):bool;
  /* as with channel.readln */
  proc readln(ref args ...):bool;
  /* as with channel.readln */
  proc readln():bool;
\end{chapel}
Objects of type \chpl{Writer} also support the following methods:
\begin{chapel}
  /* as with channel.write */
  proc write(args ...);
  /* as with channel.writeln */
  proc writeln(args ...);
  /* as with channel.writeln */
  proc writeln();
\end{chapel}

Note that objects of type \chpl{Reader} or \chpl{Writer} may represent a locked channel; as a result, using parallelism constructs to call methods on Reader or Writer may result in undefined behavior.

Because it is often more convenient to use an operator for I/O, instead of writing \chpl{f.readwrite(x); f.readwrite(y);}, one can write \chpl{f <~> x <~> y;}. Note that the types \chpl{ioLiteral} and \chpl{ioNewline} may be useful when using the \chpl{<~>}. \chpl{ioLiteral} represents some string that must be read or written as-is (e.g. \chpl{","} when working with a tuple), and \chpl{ioNewline} will emit a newline when writing but skip to and consume a newline when reading.

\begin{chapelexample}{UserReadWrite.chpl}
This example defines a readWriteThis method and demonstrates how \chpl{<~>} will
call the read or write routine, depending on the situation.

When run, the code
\begin{chapel}
class IntPair {
  var x: int;
  var y: int;
  proc readWriteThis(f) {
    f <~> x <~> new ioLiteral(",") <~> y <~> new ioNewline();
  }
}
var ip = new IntPair(17,2);
write(ip);
\end{chapel}
\begin{chapelpost}
delete ip;
\end{chapelpost}
produces the output
\begin{chapelprintoutput}{}
17,2
\end{chapelprintoutput}
\end{chapelexample}

\begin{chapelexample}{UserWrite.chpl}
This example defines a only a writeThis method - so that there will be a function resolution error if the class NoRead is read.

The code
\begin{chapel}
class NoRead {
  var x: int;
  var y: int;
  proc writeThis(f:Writer) {
    f.writeln("hello");
  }
  // Note that no readThis function will be generated.
}
var nr = new NoRead();
write(nr);
// Note that read(nr) will generate a compiler error.
\end{chapel}
\begin{chapelpost}
delete nr;
\end{chapelpost}
prints out
\begin{chapelprintoutput}{}
hello
\end{chapelprintoutput}
\end{chapelexample}


\subsection{Generalized {\em write} and {\em writeln}}
\label{writer}
\index{Writer@\chpl{Writer}}

The \chpl{Writer} class contains no arguments and serves as a base
class to allow user-defined classes to be written to.  If a class is
defined to be a subclass of Writer, it must override
the \chpl{writeIt} method that takes a \chpl{string} as an argument.

\begin{chapelexample}{UserWriter.chpl}
The following code defines a subclass of \chpl{Writer} that overrides
the \chpl{writeIt} method to allow it to be written to.  It also
overrides the \chpl{writeThis} method to override the default way that
it is written.
\begin{chapel}
class C: Writer {
  var data: string;
  proc writePrimitive(x) {
    var s = x:string;
    data += s[1];
  }
  proc writeThis(x: Writer) {
    x.write(data);
  }
}

var c = new C();
c.write(41, 32, 23, 14);
writeln(c);
\end{chapel}
\begin{chapelpost}
delete c;
\end{chapelpost}
The \chpl{C} class filters the arguments sent to it, printing out only
the first letter.  The output to the above is thus:
% TODO: when 'chapelprintoutput' is extended with some wording,
% move things around so that the printed text is well-composed.
\begin{chapelprintoutput}{}
4321
\end{chapelprintoutput}
\end{chapelexample}


%TODO: \subsection{Generalized {\em read} and {\em readln}}


%TODO: define the error behavior of read/write/readThis/writeThis/Reader/Writer


\subsection{Default {\em write} and {\em read} Methods}
\index{write@\chpl{write}!default method}
\index{read@\chpl{read}!default method}

% TODO: these should be moved to the chapters for the corresponding
% data types

% TODO: these are methods on channels, taking arguments of all types.
% Need to make that clear in the text.

Default \chpl{write} methods are created for all types for which a user-defined
\chpl{write} method is not provided.  They have the following semantics:
\begin{itemize}
\item
{\bf arrays} Outputs the elements of the array in row-major order
where rows are separated by line-feeds and blank lines are used to
separate other dimensions.
\item
{\bf domains} Outputs the dimensions of the domain enclosed
by \chpl{[} and \chpl{]}.
\item
{\bf ranges} Outputs the lower bound of the range followed
by \chpl{..} followed by the upper bound of the range.  If the stride
of the range is not one, the output is additionally followed by the
word \chpl{by} followed by the stride of the range.
\item
{\bf tuples} Outputs the components of the tuple in order delimited
by \chpl{(} and \chpl{)}, and separated by commas.
\item
{\bf classes} Outputs the values within the fields of the class
prefixed by the name of the field and the character \chpl{=}.  Each
field is separated by a comma.  The output is delimited by \chpl{\{}
and \chpl{\}}.
\item
{\bf records} Outputs the values within the fields of the class
prefixed by the name of the field and the character \chpl{=}.  Each
field is separated by a comma.  The output is delimited by \chpl{(}
and \chpl{)}.
\end{itemize}

Default \chpl{read} methods are created for all types for which a user-defined
\chpl{read} method is not provided.  The default \chpl{read} methods are
defined to read in the output of the default \chpl{write} method.
