#!/usr/bin/env python

#
# Allow 1% variance for Kernel 4 get and put counts
#

import sys, os

if os.getenv('CHPL_COMM')==None or os.getenv('CHPL_COMM')=='none':
    # do nothing for comm none
    sys.exit(0)

if len(sys.argv) < 3:
    sys.stdout.write('usage: '+sys.argv[0]+' testname logfile');
    sys.exit(-1)

#
# Latest approximate communication counts
#
commTypes = ['get', 'get_nb', 'get_nb_test', 'get_nb_wait', 'put', 'fork', 'fork_fast', 'fork_nb']
l0 = [31859, 0, 0, 0, 0, 6566, 0, 0]
l1 = [41237, 0, 0, 0, 0, 7318, 0, 0]
l2 = [37823, 0, 0, 0, 0, 6742, 0, 0]
l3 = [39865, 0, 0, 0, 0, 6837, 0, 0]
counts = [l0, l1, l2, l3]

logfile = sys.argv[2]

f=open(logfile, 'r')
lines = f.readlines()
f.close()

tmpfile=logfile+'.tmp'
f=open(tmpfile, 'w')
for l in lines:
    if l.find('Kernel 4: (')==0:
        f.write('Kernel 4:\n')
        ldata = l[10:].split(')')
        # for each locale's data
        for i in range(4):
            commDiags=ldata[i][1:].split(',')
            for d in range(8):
                target = counts[i][d]
                curr=int(commDiags[d].split('=')[1].strip())
                # gets
                if d==0:
                    max=int(1.1*float(target)) # truncates
                    if (curr>=target) and (curr<=max):
                        f.write('%d: %s: %d-%d\n'%(i, commTypes[d], target, max))
                    else:
                        f.write('%d: %s: %d (expected %d-%d)\n'%(i, commTypes[d], curr, target, max))
                # forks
                elif d==5:
                    err=int(0.01*float(target)) # truncates
                    if (curr>=target-err) and (curr<=target+err):
                        f.write('%d: %s: %d (~1%%)\n'%(i, commTypes[d], target))
                    else:
                        f.write('%d: %s: %d (expected %d ~1%%)\n'%(i, commTypes[d], curr, target))
                else:
                    # zero counts must match exactly
                    f.write('%d: %s: %d\n'%(i, commTypes[d], curr))
            
                
    else:
        # write out the line as is
        f.write(l)

f.close()

os.rename(tmpfile, logfile)
