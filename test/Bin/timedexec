#!/usr/bin/perl

#
# @ARGV[0] = "-S"
# @ARGV[1] = <timeout value>
# @ARGV[2...] = command to run
#

$| = 1;					# will flush buffers after write

#setpgrp(0,0);

eval {
    local $SIG{ALRM} = sub { die "alarm\n" };
    alarm @ARGV[0];
    if (!defined($child_pid = fork())) {
        print "timedexec cannot fork child\n";
        exit(1);
    } elsif ($child_pid == 0) {
        setpgrp(0,0);
        exec @ARGV[1..$#ARGV];
        die "timedexec failed to execute: $1\n";
    } else {
        waitpid($child_pid, 0);
        if ($? == -1) {
            print "timedexec failed to execute: $!\n";
            exit(1);
        } elsif ($? & 127) {
            printf "timedexec died with signal %d, %s coredump\n",
                   ($? & 127), ($? & 128) ? 'with' : 'without';
            exit(1);
        } else {
            $cmdStatus = $? >> 8;
        }

    }        
    alarm 0;
};
die if $@ && $@ ne "alarm\n";
if ($@) {
    print "timedexec Alarm Clock\n";
#    $child_pgrp = getpgrp($child_pid);
#    $self_pgrp = getpgrp($$);
    kill (-9, $child_pid);
    exit(222);
} else {
    exit($cmdStatus);
}
