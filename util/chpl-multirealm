#!/bin/bash

if [ x"$1" = x"-h" -o x"$1" = x"-help" -o x"$1" = x"--h" -o x"$1" = x"--help" ]; then
    echo "Run chpl-multirealm like you would run chpl."
    echo "Usage: chpl-multirealm [flags] [source files]"
    echo " "
    echo "Returns: two files per realm compiled on first file defined in hostfile.<realm>"
    echo "   a.out_<realm>"
    echo "   a.out_<realm>_real"
    echo "Run a.out_<realm> on correct architecture to use."
    echo "See README.multirealm for example usage."
    if [ -z "$2" ]; then
        exit 0
    fi
fi

# First, make sure $CHPL_HOME is set. If not, make it $PWD.
if [ -z "$CHPL_HOME" ]; then
    FULLPATH="$(dirname $(readlink -f $0))/../"
    CHPL_HOME="$FULLPATH"
fi

# Collect all platforms from -srealmTypes='arch1 arch2 arch3 ...'
j=1
OFSPACE=0
ODSPACE=0
OUTFILE=""
OUTDIR=""
for arg in "$@"; do
    if [ x"$OFSPACE" = x"1" ]; then
        OUTFILE=`echo $arg`
        OFSPACE=0
    elif [ x"$ODSPACE" = x"1" ]; then
        OUTDIR=`echo $arg`
        ODSPACE=0
    else
        FIRSTCHARACTER=`echo $arg | cut -c1`
        SECONDCHARACTER=`echo $arg | cut -c2`
        THIRDCHARACTER=`echo $arg | cut -c3`
        FOURTHCHARACTER=`echo $arg | cut -c4`
        FIFTHCHARACTER=`echo $arg | cut -c5`
        SIXTHCHARACTER=`echo $arg | cut -c6`
        SEVENTHCHARACTER=`echo $arg | cut -c7`
        FLAGCHARS=`echo $arg | cut -c3-13`
        if [ x"$FIRSTCHARACTER" = x"-" -a x"$SECONDCHARACTER" = x"-" -a x"$THIRDCHARACTER" = x"s" -a x"$FOURTHCHARACTER" = x"a" -a x"$FIFTHCHARACTER" = x"v" -a x"$SIXTHCHARACTER" = x"e" -a x"$SEVENTHCHARACTER" = x"c" ]; then
            OUTDIR=`echo $arg | cut -c8-`
            if [ -z "$OUTDIR" ]; then
                ODSPACE=1
            fi
        elif [ x"$FIRSTCHARACTER" = x"-" -a x"$SECONDCHARACTER" = x"s" -a x"$FLAGCHARS" = x"realmTypes=" ]; then
            PLATFORMLIST=`echo $arg | cut -c14-`
        elif [ x"$FIRSTCHARACTER" = x"-" -a x"$SECONDCHARACTER" = x"o" ]; then
            OUTFILE=`echo $arg | cut -c3-`
            if [ -z "$OUTFILE" ]; then
                OFSPACE=1
            fi
        fi
    fi
    j=$(($j+1))
done

if [ -z "$PLATFORMLIST" ]; then
    echo "Error: realmTypes is empty."
    exit 1
fi

# If -o is a directory, quit.
if [ -d "$OUTFILE" ]; then
    echo "Error: $OUTFILE is a directory, not a filename."
    exit 1
fi

# If -o isn't given, set to a.out.
if [ -z "$OUTFILE" ]; then
    OUTFILE=a.out
fi

# Check to see if last character of --savec path is a backslash.
# If so, remove it.
LASTNUM=`echo $OUTDIR | wc -c`
LASTNUM=$(($LASTNUM-1))
if [ ! x"$LASTNUM" = x"0" ]; then
    LASTCHARACTER=`echo $OUTDIR | cut -c$LASTNUM`
    if [ x"$LASTCHARACTER" = x"/" ]; then
        LASTNUM=$(($LASTNUM-1))
        OUTDIR=`echo $OUTDIR | cut -c1-$LASTNUM`
    fi
fi

# Get the list of hosts to build on via platform hostfiles.
HOSTLIST=""
for arg in "$PLATFORMLIST"; do
    for arg2 in $arg; do
        HOSTFILE="$CHPL_HOME"/hostfile."$arg2"
        if [ ! -r "$HOSTFILE" ]; then
            echo "$HOSTFILE not readable."
            exit 1
        fi
        HOSTS=`cat $HOSTFILE`
        if [ -z "$HOSTS" ]; then
            echo "$HOSTFILE is empty."
            exit 1
        fi
        for host in $HOSTS; do
            HOSTLIST="$HOSTLIST $host"
            break
        done
    done
done

# Since we can't remotely send $@, use this hacky workaround for now.
i=1
for arg in "$@"; do
    FIRSTCHARACTER=`echo $arg | cut -c1`
    SECONDCHARACTER=`echo $arg | cut -c2`
    FLAGCHARS=`echo $arg | cut -c3-13`
    if [ x"$FIRSTCHARACTER" = x"-" -a x"$SECONDCHARACTER" = x"s" -a x"$FLAGCHARS" = x"realmTypes=" ]; then
        FLAGARCHS=`echo $arg | cut -c14-`
        ARG[$i]=`echo ${FIRSTCHARACTER}${SECONDCHARACTER}${FLAGCHARS}\'${FLAGARCHS}\'`
    else
        ARG[$i]=$arg
    fi
    i=$(($i+1))
done

# Main loop.
i=1
for host in ${HOSTLIST}; do
    echo "Starting build on ${host}."
    platform=`echo ${PLATFORMLIST} | awk '{print $'$i'}'`
    REMOTEPATHNAMEPLUS=$(eval echo $`echo CHPL_MULTIREALM_LAUNCH_DIR_$platform`)
    REMOTEPATHNAME=`echo $REMOTEPATHNAMEPLUS | awk -F- '{print $1}'`

    if [ ! -z "$REMOTEPATHNAME" ]; then
        CHECK=`echo $OUTFILE | grep "/"`
        if [ -z "$CHECK" ]; then
            if [ x"$host" = x`uname -n` ]; then
                if [ ! -z "$OUTDIR" ]; then
                    ${CHPL_HOME}/bin/$platform/chpl "$@" -o "$REMOTEPATHNAME"/"$OUTFILE"_$platform --savec "$OUTDIR"_$platform
                else
                    ${CHPL_HOME}/bin/$platform/chpl "$@" -o "$REMOTEPATHNAME"/"$OUTFILE"_$platform
                fi
            else
                CMD='env | grep ^SHELL= | awk -F= '"'"'{print $2}'"'"
                RSHELL="$(ssh $host "$CMD")"
                if [ x"${RSHELL}" = x/bin/tcsh -o x"${RSHELL}" = x/bin/csh ]; then
                    if [ ! -z "$OUTDIR" ]; then
                        ssh ${host} "setenv CHPL_HOME ${CHPL_HOME}; setenv CHPL_COMM ${CHPL_COMM}; setenv CHPL_DEVELOPER ${CHPL_DEVELOPER}; setenv OUTFILE ${OUTFILE}; setenv platform ${platform}; setenv OUTDIR ${OUTDIR}; setenv CHPL_HOST_PLATFORM ${platform}; setenv CHPL_TARGET_PLATFORM ${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o $REMOTEPATHNAME/${OUTFILE}_${platform} --savec ${OUTDIR}_${platform}"
                    else
                        ssh ${host} "setenv CHPL_HOME ${CHPL_HOME}; setenv CHPL_COMM ${CHPL_COMM}; setenv CHPL_DEVELOPER ${CHPL_DEVELOPER}; setenv OUTFILE ${OUTFILE}; setenv platform ${platform}; setenv CHPL_HOST_PLATFORM ${platform}; setenv CHPL_TARGET_PLATFORM ${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o $REMOTEPATHNAME/${OUTFILE}_${platform}"
                    fi
                elif [ x"${RSHELL}" = x/bin/ksh -o x"${RSHELL}" = x/bin/bash ]; then
                    if [ ! -z "$OUTDIR" ]; then
                        ssh ${host} "export CHPL_HOME=${CHPL_HOME}; export CHPL_COMM=${CHPL_COMM}; export CHPL_DEVELOPER=${CHPL_DEVELOPER}; export OUTFILE=${OUTFILE}; export platform=${platform}; export OUTDIR=${OUTDIR}; export CHPL_HOST_PLATFORM=${platform}; export CHPL_TARGET_PLATFORM=${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o $REMOTEPATHNAME/${OUTFILE}_${platform} --savec ${OUTDIR}_${platform}"
                    else
                        ssh ${host} "export CHPL_HOME=${CHPL_HOME}; export CHPL_COMM=${CHPL_COMM}; export CHPL_DEVELOPER=${CHPL_DEVELOPER}; export OUTFILE=${OUTFILE}; export platform=${platform}; export CHPL_HOST_PLATFORM=${platform}; export CHPL_TARGET_PLATFORM=${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o $REMOTEPATHNAME/${OUTFILE}_${platform}"
                    fi
                else
                    echo "Unknown shell $RSHELL on $host."
                fi
            fi
        else
            echo "With CHPL_MULTIREALM_LAUNCH_DIR_"$platform" set, you cannot use an output path."
            echo "Compilation not successful on "$platform
        fi

    else
        if [ x"$host" = x`uname -n` ]; then
            if [ ! -z "$OUTDIR" ]; then
                ${CHPL_HOME}/bin/$platform/chpl "$@" -o "$OUTFILE"_$platform --savec "$OUTDIR"_$platform
            else
                ${CHPL_HOME}/bin/$platform/chpl "$@" -o "$OUTFILE"_$platform
            fi
        else
            CMD='env | grep ^SHELL= | awk -F= '"'"'{print $2}'"'"
            RSHELL="$(ssh $host "$CMD")"
            if [ x"${RSHELL}" = x/bin/tcsh -o x"${RSHELL}" = x/bin/csh ]; then
                if [ ! -z "$OUTDIR" ]; then
                    ssh ${host} "setenv CHPL_HOME ${CHPL_HOME}; setenv CHPL_COMM ${CHPL_COMM}; setenv CHPL_DEVELOPER ${CHPL_DEVELOPER}; setenv OUTFILE ${OUTFILE}; setenv platform ${platform}; setenv OUTDIR ${OUTDIR}; setenv CHPL_HOST_PLATFORM ${platform}; setenv CHPL_TARGET_PLATFORM ${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o ${OUTFILE}_${platform} --savec ${OUTDIR}_${platform}"
                else
                    ssh ${host} "setenv CHPL_HOME ${CHPL_HOME}; setenv CHPL_COMM ${CHPL_COMM}; setenv CHPL_DEVELOPER ${CHPL_DEVELOPER}; setenv OUTFILE ${OUTFILE}; setenv platform ${platform}; setenv CHPL_HOST_PLATFORM ${platform}; setenv CHPL_TARGET_PLATFORM ${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o ${OUTFILE}_${platform}"
                fi
            elif [ x"${RSHELL}" = x/bin/ksh -o x"${RSHELL}" = x/bin/bash ]; then
                if [ ! -z "$OUTDIR" ]; then
                    ssh ${host} "export CHPL_HOME=${CHPL_HOME}; export CHPL_COMM=${CHPL_COMM}; export CHPL_DEVELOPER=${CHPL_DEVELOPER}; export OUTFILE=${OUTFILE}; export platform=${platform}; export OUTDIR=${OUTDIR}; export CHPL_HOST_PLATFORM=${platform}; export CHPL_TARGET_PLATFORM=${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o ${OUTFILE}_${platform} --savec ${OUTDIR}_${platform}"
                else
                    ssh ${host} "export CHPL_HOME=${CHPL_HOME}; export CHPL_COMM=${CHPL_COMM}; export CHPL_DEVELOPER=${CHPL_DEVELOPER}; export OUTFILE=${OUTFILE}; export platform=${platform}; export CHPL_HOST_PLATFORM=${platform}; export CHPL_TARGET_PLATFORM=${platform}; cd ${PWD}; ${CHPL_HOME}/bin/$platform/chpl ${ARG[1]} ${ARG[2]} ${ARG[3]} ${ARG[4]} ${ARG[5]} ${ARG[6]} ${ARG[7]} ${ARG[8]} ${ARG[9]} ${ARG[10]} ${ARG[11]} ${ARG[12]} ${ARG[13]} ${ARG[14]} ${ARG[15]} ${ARG[16]} ${ARG[17]} ${ARG[18]} ${ARG[19]} ${ARG[20]} ${ARG[21]} ${ARG[22]} ${ARG[23]} ${ARG[24]} ${ARG[25]} ${ARG[26]} ${ARG[27]} ${ARG[28]} ${ARG[29]} ${ARG[30]} ${ARG[31]} ${ARG[32]} ${ARG[33]} ${ARG[34]} ${ARG[35]} ${ARG[36]} ${ARG[37]} ${ARG[38]} ${ARG[39]} ${ARG[40]} ${ARG[41]} ${ARG[42]} ${ARG[43]} ${ARG[44]} ${ARG[45]} ${ARG[46]} ${ARG[47]} ${ARG[48]} ${ARG[49]} ${ARG[50]} ${ARG[51]} ${ARG[52]} ${ARG[53]} ${ARG[54]} ${ARG[55]} ${ARG[56]} ${ARG[57]} ${ARG[58]} ${ARG[59]} ${ARG[60]} ${ARG[61]} ${ARG[62]} ${ARG[63]} ${ARG[64]} ${ARG[65]} ${ARG[66]} ${ARG[67]} ${ARG[68]} ${ARG[69]} ${ARG[70]} ${ARG[71]} ${ARG[72]} ${ARG[73]} ${ARG[74]} ${ARG[75]} ${ARG[76]} ${ARG[77]} ${ARG[78]} ${ARG[79]} ${ARG[80]} ${ARG[81]} ${ARG[82]} ${ARG[83]} ${ARG[84]} ${ARG[85]} ${ARG[86]} ${ARG[87]} ${ARG[88]} ${ARG[89]} ${ARG[90]} ${ARG[91]} ${ARG[92]} ${ARG[93]} ${ARG[94]} ${ARG[95]} ${ARG[96]} ${ARG[97]} ${ARG[98]} ${ARG[99]} ${ARG[100]} ${ARG[101]} ${ARG[102]} ${ARG[103]} ${ARG[104]} ${ARG[105]} ${ARG[106]} ${ARG[107]} ${ARG[108]} ${ARG[109]} ${ARG[110]} ${ARG[111]} ${ARG[112]} ${ARG[113]} ${ARG[114]} ${ARG[115]} ${ARG[116]} ${ARG[117]} ${ARG[118]} ${ARG[119]} ${ARG[120]} ${ARG[121]} ${ARG[122]} ${ARG[123]} ${ARG[124]} ${ARG[125]} ${ARG[126]} ${ARG[127]} ${ARG[128]} -o ${OUTFILE}_${platform}"
                fi
            else
                echo "Unknown shell $RSHELL on $host."
            fi
        fi
    fi
    i=$(($i+1))
    echo "Finished build on ${host}."
done

exit
