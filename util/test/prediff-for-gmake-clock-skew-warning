#!/bin/sh

# This script is for the use with 'start_test' as the system-wide prediff, when
# network time-sync problems (or similar) cause file modification times to look
# wrong to gmake.

# This typically occurs when a remote-mounted NFS file system is used as a workspace.
# It has also been observed less frequently on VMs, even when using a local vdisk.

# In either case, it is not unusual to see lines like these in chpl compiler output:
#
# gmake: Warning: File `.../something' has modification time 0.01 s in the future
# gmake: warning:  Clock skew detected.  Your build may be incomplete.

# This prediff file removes such lines, so that they will not generate false test
# errors in start_test.

# To use this prediff file with start_test (assuming bash):
#
# export CHPL_SYSTEM_PREDIFF=$CHPL_HOME/util/test/prediff-for-gmake-clock-skew-warning
# start_test ...

outfile=$2
temp=$outfile.temp

# check the outfile for null characters
# if found, then outfile is binary, the grep filter will not work, so DO NOT run the filter

  # tr removes null chars, if any
LC_ALL=C tr -d '\000' < $outfile > $temp
  # did the outfile contain any null chars?
LC_ALL=C diff -q $outfile $temp
if [ $? != 0 ]; then
    # yes: the outfile is binary, do not run the filter
    rm -f $temp
    exit 0
fi

# filter out gmake "clock skew detected" warnings (if any) from the outfile, with grep

grep < $outfile > $temp -Ev '^g?make(\[[0-9]+\])?: *[Ww]arning: *(File .* has modification time .* in the future|Clock skew detected\. *Your build may be incomplete\.) *$'

mv $temp $outfile
