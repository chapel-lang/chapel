#!/bin/bash -l
# Run this from the examples directory
#
# This never works out of the box.  See comments below.
#

#
# When running on a white box, e.g., chplbld01 or chplbld02, you want
# to make sure you have the right network module installed.
# Currently, chpbld01 is set up to support XT and chpbld02 is set up
# to support XE, for some defintion of "support".  So if you log into
# one and the wrong network module is loaded, make sure you swap them
# before you do anything else, e.g., 'module swap xtpe-network-gemini
# xtpe-network-sestar.
#
# Some of the newer modules do not support XT any more, so you may
# need to swap out other modules.  The latest list I got is:
#
#    module swap cce cce/7.4.4
#    module swap acml acml/4.4.0
#
# Other issues specific to the 1.5.0 release:
#
# - We found that there was an issue with having hugepages (XE) loaded
#   and compiling with gasnet+fast.  See platform/README.xe-cle for
#   the workaround.
#
# - We run into some incompatibility with the PGI compiler (XT & XE).
#   Our module is built using 12.3.0, and it appears that we cannot
#   compile a user programs with 12.2.0.
#
# - The module for mpich is not automatically loaded, even when you
# - load the programming environment.  See below.
#

#
# When running on a chpbld01/02, you probably want to uncomment the
# following:
#
# . /etc/profile
# unset CHPL_COMM
# unset CHPL_DEVELOPER
# unset CHPL_GASNET_SEGMENT
# unset CHPL_COMM
# unset CHPL_HOME
# module load chapel/1.5.0
# if [ "$CHPL_HOST_PLATFORM" == "xt-cle" ]
# then
#     module load xt-mpt  # or 'module load xt-mpich2/5.3.4'
# elif [ "$CHPL_HOST_PLATFORM" == "xe-cle" ]
# then
#     module load xt-mpich2
# else
#     echo "Unrecognized \$CHPL_HOST_PLATFORM"
#     exit -1
# fi

PES=""

if [[ $# -ge 1 ]] ; then
    COMPILE_ONLY=1
else
    COMPILE_ONLY=0
fi

if [ "$PES" == "" ] ; then
   PES="gnu pgi intel cray"
fi

# COMMS="gasnet none"
COMMS="gasnet"
# LAUNCHERS="pbs-aprun aprun none"
LAUNCHERS="pbs-aprun"

if [ "$CHPL_HOST_PLATFORM" == "xt-cle" ]
then
    SUBSTRATES="portals mpi"
elif [ "$CHPL_HOST_PLATFORM" == "xe-cle" ]
then
    SUBSTRATES="gemini mpi"
else
    echo "Unrecognized \$CHPL_HOST_PLATFORM"
    exit -1
fi

TESTS="benchmarks/hpcc/stream"

old=`module list 2>&1 | grep PrgEnv | awk '{ print $NF }' | awk -F / '{ print $1 }'`

# echo $old

for pe in $PES ; do
    new="PrgEnv-"$pe
    echo "***"
    echo "*** Testing $new"
    echo "***"
    module swap $old $new
    tnew=`module list 2>&1 | grep PrgEnv | awk '{ print $NF }' | awk -F / '{ print $1 }'`
    if [ "$tnew" != $new ]; then
       echo "***"
       echo "*** MODULE NOT FOUND: $new"
       echo "***"
       continue
    fi
    module show $new

    for COMM in $COMMS ; do
        export CHPL_COMM=$COMM
        if [ "$COMM" == "gasnet" ]
        then
            SUBS=$SUBSTRATES
        else
            SUBS="none"
        fi

        for SUB in $SUBS ; do

            export CHPL_COMM_SUBSTRATE=$SUB
            for LAUNCHER in $LAUNCHERS ; do
                echo "***"
                echo "*** Building examples"
                echo "***"
                $CHPL_HOME/util/printchplenv
                make clean
                make hello6-taskpar-dist $TESTS
                if [ "$COMPILE_ONLY" != 0 ] ; then
                    echo "***"
                    echo "*** Running hello6-taskpar-dist"
                    ./hello6-taskpar-dist `cat hello6-taskpar-dist.execopts` -nl `cat NUMLOCALES` -q | sort - | diff hello6-taskpar-dist.good -
                    if [ $? != 0 ] ; then
                        echo "***"
                        echo "*** TEST FAILED: $t"
                        echo "***"
                    fi
                    # no prediff or special .good files
                    for t in $TESTS ; do
	                echo "*** Running $t"
	                ./$t `cat $t.execopts` -nl `cat NUMLOCALES` -q | diff $t.good -
	                if [ $? != 0 ] ; then
	                    echo "***"
	                    echo "*** TEST FAILED: $t"
	                    echo "***"
	                fi
                    done
                fi
            done
        done
    done

    unset CHPL_COMM_SUBSTRATE
    if [ "$pe" == "gnu" ] && [ "$CHPL_HOST_PLATFORM" == "xe-cle" ] ; then
      # build the proprietary stuff

        export CHPL_TASKS=muxed
        export CHPL_MEM=tcmalloc
        export CHPL_COMM=ugni
        module load craype-hugepages2M
        for LAUNCHER in $LAUNCHERS ; do
            echo "***"
            echo "*** Building examples"
            echo "***"
            $CHPL_HOME/util/printchplenv
            make clean
            make hello6-taskpar-dist $TESTS
            if [ "$COMPILE_ONLY" != 0 ] ; then
                echo "***"
                echo "*** Running hello6-taskpar-dist"
                ./hello6-taskpar-dist `cat hello6-taskpar-dist.execopts` -nl `cat NUMLOCALES` -q | sort - | diff hello6-taskpar-dist.good -
                if [ $? != 0 ] ; then
                    echo "***"
                    echo "*** TEST FAILED: $t"
                    echo "***"
                fi
                # no prediff or special .good files
                for t in $TESTS ; do
	            echo "*** Running $t"
	            ./$t `cat $t.execopts` -nl `cat NUMLOCALES` -q | diff $t.good -
	            if [ $? != 0 ] ; then
	                echo "***"
	                echo "*** TEST FAILED: $t"
	                echo "***"
	            fi
                done
            fi
        done
        unset CHPL_TASKS
        unset CHPL_MEM
        module unload craype-hugepages2M
    fi

    old=$new
done
