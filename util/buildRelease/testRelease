#!/usr/bin/env bash

# Converted from Perl to Bash. Original behavior preserved.
# Creates a test release tarball, unpacks it in a temp dir, runs tests,
# and cleans up on success.

set -e
set -x

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Keeping chplhomedir for parity with original (though unused later)
chplhomedir="$(cd "$script_dir/../.." && pwd)"

# Uniquifiers / meta (pid unused but kept for parity)
pid="$$"
user="$(whoami)"

chplhome="$CHPL_HOME"

# Determine base tmp directory
basetmpdir="${CHPL_NIGHTLY_TMPDIR:-${TMPDIR:-/tmp}}"
tmpdir="$basetmpdir/chapel-testRelease.$user.deleteme"

somethingfailed=0

#
# make temp directory
#
rm -rf $tmpdir
mkdir -p $tmpdir > /dev/null

#
# Remove previous tarball (non-fatal)
#
rm -f $chplhome/tar/chapel-test.tar.gz || true

#
# make release
#
$chplhome/util/buildRelease/gen_release test

#
# copy release to temp directory, unpack, and run tests
#
cp $chplhome/tar/chapel-test.tar.gz $tmpdir
cd $tmpdir && tar xf chapel-test.tar.gz

# Run testReleaseHelp (capture chpl_make output first for clarity)
chpl_make_cmd_output="$("$chplhome"/util/chplenv/chpl_make.py)"
cd $tmpdir/chapel-test && $chplhome/util/buildRelease/testReleaseHelp $chpl_make_cmd_output

# Cleanup if everything succeeded
if [[ $somethingfailed -eq 0 ]]; then
    echo "Cleaning up"
    rm -rf $tmpdir || true
fi
